<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karuna - A Transparent Charity Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full">
        <h1 class="text-4xl font-bold text-center mb-6 text-indigo-600">Karuna</h1>
        <p class="text-center text-lg text-gray-600 mb-8">A transparent charity platform powered by the Stacks
            blockchain.</p>

        <div id="wallet-status" class="text-center text-sm font-semibold mb-6">
            <button id="connect-btn"
                class="py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Connect Wallet
            </button>
            <span id="connected-address" class="hidden text-green-500 font-semibold"></span>
        </div>

        <!-- Donation form -->
        <div class="bg-gray-50 p-6 rounded-lg mb-6">
            <h2 class="text-2xl font-bold mb-4 text-center text-indigo-500">Donate to a Project</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="projectId" class="block text-sm font-medium text-gray-700">Project ID (e.g., 0)</label>
                    <input type="number" id="projectId" placeholder="0"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-500 focus:ring-indigo-500" />
                </div>
                <div>
                    <label for="donationAmount" class="block text-sm font-medium text-gray-700">Amount (in STX)</label>
                    <input type="number" id="donationAmount" placeholder="10"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-500 focus:ring-indigo-500" />
                </div>
            </div>
            <button onclick="donate()"
                class="mt-6 w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                Donate
            </button>
        </div>

        <!-- Projects -->
        <div id="projects-list">
            <h2 class="text-2xl font-bold mb-4 text-center text-indigo-500">Projects</h2>
            <div class="bg-green-100 p-6 rounded-lg mb-4 shadow-md">
                <h3 class="text-xl font-bold text-green-800">Project ID: 0</h3>
                <p class="text-green-700 mt-2"><strong>Name:</strong> Emergency Relief for Flood Victims</p>
                <p class="text-green-700"><strong>Description:</strong> Providing food, shelter, and medical supplies to
                    families.</p>
                <p class="text-green-700"><strong>Goal:</strong> 1000 STX</p>
                <p class="text-green-700"><strong>Raised:</strong> <span id="raised-0">0</span> STX</p>
                <button onclick="updateProjectDetails(0)"
                    class="mt-4 py-2 px-4 border border-transparent rounded-md text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Update Details
                </button>
            </div>
            <div class="bg-yellow-100 p-6 rounded-lg mb-4 shadow-md">
                <h3 class="text-xl font-bold text-yellow-800">Project ID: 1</h3>
                <p class="text-yellow-700 mt-2"><strong>Name:</strong> Empowering Rural Education</p>
                <p class="text-yellow-700"><strong>Description:</strong> Funding new school supplies and teachers for
                    remote village schools.</p>
                <p class="text-yellow-700"><strong>Goal:</strong> 500 STX</p>
                <p class="text-yellow-700"><strong>Raised:</strong> <span id="raised-1">0</span> STX</p>
                <button onclick="updateProjectDetails(1)"
                    class="mt-4 py-2 px-4 border border-transparent rounded-md text-sm font-medium text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                    Update Details
                </button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="message-modal"
        class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-lg p-6 w-96">
            <div class="text-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-gray-900"></h3>
                <p id="modal-message" class="mt-2 text-gray-600"></p>
            </div>
            <div class="flex justify-center">
                <button onclick="closeModal()"
                    class="py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md">OK</button>
            </div>
        </div>
    </div>

    <!-- Stacks SDK scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@stacks/connect@latest/dist/umd/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stacks/transactions@latest/dist/umd/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stacks/network@latest/dist/umd/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stacks/auth@latest/dist/umd/index.js"></script>

    <script>
        // --- Configuration ---
        const CONTRACT_ADDRESS = 'ST23XZVZF6A2XSG4SJ05XT24ENQ88P3G1KCAWTP5K';
        const CONTRACT_NAME = 'karuna';
        const NETWORK = new StacksNetwork.StacksTestnet();

        // --- Wallet Setup ---
        const appConfig = new StacksAuth.AppConfig(['store_write']);
        const userSession = new StacksAuth.UserSession({ appConfig });

        const connectBtn = document.getElementById('connect-btn');
        const connectedAddress = document.getElementById('connected-address');

        async function connectWallet() {
            try {
                await StacksConnect.showConnect({
                    appDetails: { name: "Karuna", icon: "https://placehold.co/100x100/A0E7E5/fff?text=K" },
                    userSession,
                    onFinish: () => updateWalletStatus(),
                });
            } catch (error) {
                console.error("Wallet connection failed:", error);
                showMessage("Connection Failed", "Wallet connection was denied or an error occurred.", "error");
            }
        }

        function updateWalletStatus() {
            if (userSession.isUserSignedIn()) {
                const userData = userSession.loadUserData();
                connectedAddress.innerText = `Connected: ${userData.profile.stxAddress.testnet}`;
                connectedAddress.classList.remove('hidden');
                connectBtn.classList.add('hidden');
            } else {
                connectedAddress.classList.add('hidden');
                connectBtn.classList.remove('hidden');
            }
        }

        connectBtn.onclick = connectWallet;
        updateWalletStatus();

        // --- Contract Interaction ---
        async function donate() {
            if (!userSession.isUserSignedIn()) {
                showMessage("Donation Failed", "Please connect your Stacks wallet first.", "error");
                return;
            }

            const projectId = document.getElementById('projectId').value;
            const donationAmount = document.getElementById('donationAmount').value;

            if (!projectId || !donationAmount || donationAmount <= 0) {
                showMessage("Invalid Input", "Please enter a valid project ID and donation amount.", "error");
                return;
            }

            const functionArgs = [
                StacksTransactions.uintCV(parseInt(projectId)),
                StacksTransactions.uintCV(parseInt(donationAmount) * 1000000)
            ];

            const options = {
                contractAddress: CONTRACT_ADDRESS,
                contractName: CONTRACT_NAME,
                functionName: 'donate',
                functionArgs,
                network: NETWORK,
                appDetails: { name: "Karuna" },
                onFinish: (data) => {
                    console.log("Tx submitted:", data);
                    showMessage("Success", "Donation submitted! Check your wallet.", "success");
                }
            };

            try {
                await StacksConnect.openContractCall(options);
            } catch (error) {
                console.error(error);
                showMessage("Donation Failed", "Error broadcasting donation.", "error");
            }
        }

        async function updateProjectDetails(projectId) {
            const options = {
                contractAddress: CONTRACT_ADDRESS,
                contractName: CONTRACT_NAME,
                functionName: 'get-project-details',
                functionArgs: [StacksTransactions.uintCV(projectId)],
                network: NETWORK,
                senderAddress: CONTRACT_ADDRESS
            };

            try {
                const result = await StacksTransactions.callReadOnlyFunction(options);
                console.log(result);
            } catch (error) {
                console.error("Error fetching details:", error);
            }
        }

        // --- Modal ---
        function showMessage(title, message, type) {
            const modal = document.getElementById('message-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');

            modalTitle.innerText = title;
            modalMessage.innerText = message;

            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('message-modal').classList.add('hidden');
        }
    </script>
</body>

</html>